{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user account in the system, either a citizen or an official.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "userType": {
          "type": "string",
          "description": "The type of user account. Can be 'citizen', 'admin', 'regionalAuthority', 'responseUnit', or 'dataAnalyst'."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the user."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user.",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "The phone number of the user."
        },
        "socialLoginId": {
          "type": "string",
          "description": "The unique identifier from the social login provider, if applicable."
        },
        "agencyId": {
          "type": "string",
          "description": "Reference to Agency. (Relationship: User 1:N Agency). Nullable: Not applicable for citizen accounts."
        }
      },
      "required": [
        "id",
        "userType",
        "firstName",
        "lastName"
      ]
    },
    "Agency": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Agency",
      "type": "object",
      "description": "Represents a government agency or official department.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the agency entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the agency."
        },
        "description": {
          "type": "string",
          "description": "A brief description of the agency."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "type": "object",
      "description": "Represents a role-based access level.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the role entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the role (e.g., Admin, Regional Authority)."
        },
        "description": {
          "type": "string",
          "description": "A description of the role and its permissions."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "UserRole": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserRole",
      "type": "object",
      "description": "Links users to their assigned roles.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserRole entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User N:N Role)"
        },
        "roleId": {
          "type": "string",
          "description": "Reference to Role. (Relationship: User N:N Role)"
        }
      },
      "required": [
        "id",
        "userId",
        "roleId"
      ]
    },
    "Incident": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Incident",
      "type": "object",
      "description": "Represents a reported incident.",
      "properties": {
        "title": {
          "type": "string",
          "description": "Title of the incident."
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the incident."
        },
        "location": {
          "type": "string",
          "description": "Location of the incident."
        },
        "category": {
          "type": "string",
          "description": "Category of the incident (e.g., Crime, Fire)."
        },
        "status": {
          "type": "string",
          "description": "Current status of the incident."
        },
        "priority": {
          "type": "string",
          "description": "Priority of the incident."
        },
        "dateReported": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when the incident was reported."
        },
        "reporter": {
          "type": "object",
          "properties": {
            "isAnonymous": {
              "type": "boolean"
            },
            "userId": {
              "type": ["string", "null"]
            }
          }
        },
        "media": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "investigationNotes": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "note": { "type": "string" },
                    "authorId": { "type": "string" },
                    "authorName": { "type": "string" },
                    "timestamp": { "type": "string", "format": "date-time" }
                },
                "required": ["note", "authorId", "authorName", "timestamp"]
            }
        },
        "aiMetadata": {
            "type": "object",
            "properties": {
              "suggestedCategories": { "type": "array", "items": { "type": "string" } },
              "isDuplicate": { "type": "boolean" },
              "isSuspicious": { "type": "boolean" }
            }
        }
      },
      "required": ["title", "description", "location", "category", "status", "dateReported", "reporter"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user account information, including citizen and official accounts. 'userId' is the Firebase Auth UID. Includes 'agencyId' for official accounts. Uses path-based ownership, where each user can only read/write their own document.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user."
            }
          ]
        }
      },
      {
        "path": "/agencies/{agencyId}",
        "definition": {
          "entityName": "Agency",
          "schema": {
            "$ref": "#/backend/entities/Agency"
          },
          "description": "Stores information about government agencies. Only admins can create, read, update, and delete agencies. The agencyId should be used to link official users to their respective agencies.",
          "params": [
            {
              "name": "agencyId",
              "description": "The unique identifier of the agency."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Collection to store admin user IDs. Existence of a document with the user's ID in this collection grants admin privileges.  Authorization relies on document existence.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the admin user."
            }
          ]
        }
      },
      {
        "path": "/roles_regionalAuthority/{userId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Collection to store regional authority user IDs. Existence of a document with the user's ID in this collection grants regional authority privileges. Authorization relies on document existence.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the regional authority user."
            }
          ]
        }
      },
      {
        "path": "/roles_responseUnit/{userId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Collection to store response unit user IDs. Existence of a document with the user's ID in this collection grants response unit privileges. Authorization relies on document existence.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the response unit user."
            }
          ]
        }
      },
      {
        "path": "/roles_dataAnalyst/{userId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Collection to store data analyst user IDs. Existence of a document with the user's ID in this collection grants data analyst privileges. Authorization relies on document existence.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the data analyst user."
            }
          ]
        }
      },
       {
        "path": "/incidents/{incidentId}",
        "definition": {
          "entityName": "Incident",
          "schema": {
            "$ref": "#/backend/entities/Incident"
          },
          "description": "Stores all reported incidents. All signed-in users can read, but only specific roles can update or delete.",
          "params": [
            {
              "name": "incidentId",
              "description": "The unique identifier of the incident."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore data structure is designed to support user management (citizen and government agency/official accounts) with role-based access for the Zambia Tracking Incident System. It prioritizes authorization independence and QAPs (Rules are not Filters) using denormalization and structural segregation. User roles are managed via dedicated collections to avoid custom claims (DBAC). \n\nThe core strategy is to maintain clarity around access control and ownership, using path-based ownership where applicable and membership maps for collaborative data. The design leverages structural segregation by isolating data with differing security requirements into distinct collections. This approach allows for simpler and more robust security rules.\n\nSpecifically:\n\n*   **Authorization Independence:** No `get()` calls are needed in security rules because relevant authorization data (like user type and agencyId) is directly available within the document or can be evaluated from the path.\n*   **QAPs (Rules are not Filters):** Each collection has a homogeneous security posture, allowing secure `list` operations. For example, only admins can list all agencies, while regional authorities can only access agencies they are associated with via a separate query that filters by agencyId.\n*   **DBAC (No Custom Claims):** User roles are determined by their presence in dedicated role collections (e.g., `/roles_admin/{uid}`).\n*   **User Management:** Citizen and official user accounts are stored in the `/users/{userId}` collection. Agency details are stored in the `/agencies/{agencyId}` collection. The `agencyId` field in the `User` document links officials to their respective agencies. Role-based access is managed through dedicated collections for each role type (e.g., `/roles_admin/{userId}`, `/roles_regionalAuthority/{userId}`)."
  }
}
