{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user account in the system, either a citizen or an official.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "userType": {
          "type": "string",
          "description": "The type of user account. Can be 'citizen', 'admin', 'communityLeader', or 'responder'."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the user."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user.",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "The phone number of the user."
        },
        "nrc": {
          "type": "string",
          "description": "The National Registration Card number of the user."
        },
        "dateOfBirth": {
          "type": "string",
          "format": "date-time",
          "description": "The date of birth of the user."
        },
        "occupation": {
          "type": "string",
          "description": "The occupation of the user."
        },
        "province": {
          "type": "string",
          "description": "The province where the user resides."
        },
        "district": {
          "type": "string",
          "description": "The district where the user resides."
        },
        "socialLoginId": {
          "type": "string",
          "description": "The unique identifier from the social login provider, if applicable."
        },
        "departmentId": {
          "type": "string",
          "description": "Reference to Department. (Relationship: User 1:N Department). Nullable: Not applicable for citizen accounts."
        },
        "location": {
          "type": "object",
          "description": "The last known geographical location of the user.",
          "properties": {
            "latitude": { "type": "number" },
            "longitude": { "type": "number" }
          }
        },
        "locationMetadata": {
            "type": "object",
            "description": "Additional metadata about the user's location.",
            "properties": {
                "accuracy": { "type": "number" },
                "heading": { "type": ["number", "null"] },
                "speed": { "type": ["number", "null"] },
                "updatedAt": { "type": "string", "format": "date-time" }
            }
        }
      },
      "required": [
        "id",
        "userType",
        "firstName",
        "lastName",
        "phoneNumber",
        "nrc",
        "dateOfBirth",
        "occupation",
        "province",
        "district"
      ]
    },
    "Department": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Department",
      "type": "object",
      "description": "Represents a government department or official agency.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the department entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the department (e.g., Zambia Police Service)."
        },
        "category": {
          "type": "string",
          "description": "Category of the department.",
          "enum": ["Police", "Fire", "Ambulance", "Council", "Health", "Disaster", "Other"]
        },
        "province": {
          "type": "string",
          "description": "The province where the department is located."
        },
        "district": {
          "type": "string",
          "description": "The district where the department is located."
        },
        "officeAddress": {
          "type": "string",
          "description": "The physical office address of the department."
        },
        "contactNumbers": {
          "type": "object",
          "properties": {
            "landline": { "type": "string" },
            "responders": { "type": "array", "items": { "type": "string" } }
          }
        },
        "incidentTypesHandled": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of incident types this department handles."
        },
        "operatingHours": {
          "type": "string",
          "description": "The operating hours of the department (e.g., 24/7, 9am-5pm)."
        },
        "escalationRules": {
          "type": "string",
          "description": "Description of rules for escalating incidents."
        },
        "priorityAssignmentRules": {
          "type": "string",
          "description": "Description of rules for assigning priority to incidents."
        }
      },
      "required": [
        "id",
        "name",
        "category",
        "province",
        "district"
      ]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "type": "object",
      "description": "Represents a role-based access level.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the role entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the role (e.g., Admin, Community Leader)."
        },
        "description": {
          "type": "string",
          "description": "A description of the role and its permissions."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "UserRole": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserRole",
      "type": "object",
      "description": "Links users to their assigned roles.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserRole entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User N:N Role)"
        },
        "roleId": {
          "type": "string",
          "description": "Reference to Role. (Relationship: User N:N Role)"
        }
      },
      "required": [
        "id",
        "userId",
        "roleId"
      ]
    },
    "Incident": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Incident",
      "type": "object",
      "description": "Represents a reported incident.",
      "properties": {
        "title": {
          "type": "string",
          "description": "Title of the incident."
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the incident."
        },
        "location": {
          "type": "string",
          "description": "Location of the incident."
        },
        "category": {
          "type": "string",
          "description": "Category of the incident (e.g., Crime, Fire)."
        },
        "status": {
          "type": "string",
          "description": "Current status of the incident."
        },
        "priority": {
          "type": "string",
          "description": "Priority of the incident."
        },
        "dateReported": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when the incident was reported."
        },
        "reporter": {
          "type": "object",
          "properties": {
            "isAnonymous": {
              "type": "boolean"
            },
            "userId": {
              "type": ["string", "null"]
            }
          }
        },
        "media": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "investigationNotes": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "note": { "type": "string" },
                    "authorId": { "type": "string" },
                    "authorName": { "type": "string" },
                    "timestamp": { "type": "string", "format": "date-time" }
                },
                "required": ["note", "authorId", "authorName", "timestamp"]
            }
        },
        "aiMetadata": {
            "type": "object",
            "properties": {
              "suggestedCategories": { "type": "array", "items": { "type": "string" } },
              "isDuplicate": { "type": "boolean" },
              "isSuspicious": { "type": "boolean" }
            }
        },
        "assignedTo": {
            "type": ["string", "null"],
            "enum": ["Police", "Fire", "Ambulance", null],
            "description": "The responder unit assigned to the incident."
        },
        "dateVerified": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when the incident was verified."
        },
        "dateDispatched": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when a team was dispatched."
        },
        "dateResolved": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when the incident was resolved."
        }
      },
      "required": ["title", "description", "location", "category", "status", "dateReported", "reporter"]
    },
    "Asset": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Asset",
      "type": "object",
      "description": "Represents a physical or digital asset belonging to a department.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the asset."
        },
        "departmentId": {
          "type": "string",
          "description": "The ID of the department this asset belongs to."
        },
        "assetType": {
          "type": "string",
          "enum": ["Vehicle", "Equipment", "Station/Post", "Response Team"],
          "description": "The type of the asset."
        },
        "name": {
          "type": "string",
          "description": "A descriptive name for the asset (e.g., 'Patrol Car 12', 'Fire Extinguisher #5')."
        },
        "status": {
          "type": "string",
          "description": "Current status of the asset (e.g., 'Active', 'Under Maintenance', 'Decommissioned')."
        },
        "details": {
          "type": "object",
          "description": "Additional details specific to the asset type."
        }
      },
      "required": ["id", "departmentId", "assetType", "name", "status"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user account information, including citizen and official accounts. 'userId' is the Firebase Auth UID. Includes 'departmentId' for official accounts. Uses path-based ownership, where each user can only read/write their own document.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user."
            }
          ]
        }
      },
      {
        "path": "/departments/{departmentId}",
        "definition": {
          "entityName": "Department",
          "schema": {
            "$ref": "#/backend/entities/Department"
          },
          "description": "Stores information about government departments. Only admins can create, read, update, and delete departments. The departmentId should be used to link official users to their respective departments.",
          "params": [
            {
              "name": "departmentId",
              "description": "The unique identifier of the department."
            }
          ]
        }
      },
      {
        "path": "/departments/{departmentId}/assets/{assetId}",
        "definition": {
          "entityName": "Asset",
          "schema": {
            "$ref": "#/backend/entities/Asset"
          },
          "description": "Stores assets for a specific department. Department staff can manage their own assets.",
          "params": [
            {
              "name": "departmentId",
              "description": "The unique identifier of the department."
            },
            {
               "name": "assetId",
               "description": "The unique identifier of the asset."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Collection to store admin user IDs. Existence of a document with the user's ID in this collection grants admin privileges.  Authorization relies on document existence.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the admin user."
            }
          ]
        }
      },
      {
        "path": "/roles_communityLeader/{userId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Collection to store community leader user IDs. Grants privileges to approve reports and send local alerts.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the community leader user."
            }
          ]
        }
      },
      {
        "path": "/roles_responder/{userId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Collection to store responder user IDs (Police, Fire, Ambulance). Existence grants responder privileges.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the responder user."
            }
          ]
        }
      },
       {
        "path": "/incidents/{incidentId}",
        "definition": {
          "entityName": "Incident",
          "schema": {
            "$ref": "#/backend/entities/Incident"
          },
          "description": "Stores all reported incidents. All signed-in users can read, but only specific roles can update or delete.",
          "params": [
            {
              "name": "incidentId",
              "description": "The unique identifier of the incident."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore data structure is designed to support user management with role-based access for the Zambia Tracking Incident System. It prioritizes authorization independence and QAPs (Rules are not Filters) using denormalization and structural segregation. User roles are managed via dedicated collections to avoid custom claims (DBAC). \n\nThe core strategy is to maintain clarity around access control and ownership, using path-based ownership where applicable and membership maps for collaborative data. The design leverages structural segregation by isolating data with differing security requirements into distinct collections. This approach allows for simpler and more robust security rules.\n\nSpecifically:\n\n*   **Authorization Independence:** No `get()` calls are needed in security rules because relevant authorization data (like user type and departmentId) is directly available within the document or can be evaluated from the path.\n*   **QAPs (Rules are not Filters):** Each collection has a homogeneous security posture, allowing secure `list` operations.\n*   **DBAC (No Custom Claims):** User roles are determined by their presence in dedicated role collections (e.g., `/roles_admin/{uid}`).\n*   **User Management:** Citizen and official user accounts are stored in the `/users/{userId}` collection. Department details are stored in the `/departments/{departmentId}` collection. The `departmentId` field in the `User` document links officials to their respective departments. Role-based access is managed through dedicated collections for each role type."
  }
}

    